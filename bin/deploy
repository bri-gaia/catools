#!/usr/bin/env bash
set -x
set -e
set -u
ln -sf vendor/collectiveaccess/providence $COLLECTIVEACCESS_HOME
ln -sf $APP_ROOT/setup.php $COLLECTIVEACCESS_HOME/
[ -d $APP_ROOT/$PROFILE.xml ] && ln -sf $APP_ROOT/installation-profile/profile/$PROFILE.xml $COLLECTIVEACCESS_HOME/install/profiles/xml/$PROFILE.xml
[ -d $APP_ROOT/plugins ] && ln -sf $APP_ROOT/plugins/* $COLLECTIVEACCESS_HOME/app/plugins/
[ -d $APP_ROOT/themes ] && ln -sf $APP_ROOT/themes/* $COLLECTIVEACCESS_HOME/themes/
[ -d $APP_ROOT/printTemplates/labels ] && ln -sf $APP_ROOT/printTemplates/labels/* $COLLECTIVEACCESS_HOME/app/printTemplates/labels/local
[ -d $APP_ROOT/printTemplates/summary ] && ln -sf $APP_ROOT/printTemplates/summary/* $COLLECTIVEACCESS_HOME/app/printTemplates/summary/local
[ -d $APP_ROOT/printTemplates/results ] && ln -sf $APP_ROOT/printTemplates/results/* $COLLECTIVEACCESS_HOME/app/printTemplates/results/local
mkdir -p media/collectiveaccess
mkdir -p import
mkdir -p data
mkdir -p log
mkdir -p backups
pushd $COLLECTIVEACCESS_HOME
composer install
rm -rf media
rm -rf import
rm -rf app/log
ln -sf $APP_ROOT/media .
ln -sf $APP_ROOT/import .
ln -sf $APP_ROOT/log app/
popd

if [[ ! -z ${PAWTUCKET_HOME:-} ]]; then
    echo "Deploying pawtucket"
    deployPawtucket
fi
# Ensure media directories can be read by web server
find media/collectiveaccess -type d -exec chmod 775 {} \;

